<style>
    .content-area {
        display: flex; 
        flex-direction: column;
        align-items: center;
        padding: 12px;
    }

    .feed {
        width: -webkit-fill-available;
    }

    @keyframes wavy {
        0% {
            background-position: 0% 50%;
        }
        100% {
            background-position: 100% 50%;
        }
    }

    .meme-card {
        border: 2px solid #FFFBED;
        border-radius: 12px;
        overflow: hidden;
        z-index: 10;
        position: relative;
        margin-bottom: 12px;
        width: -webkit-fill-available;
    }

    .meme-header {
        height: fit-content;
        padding: 18px;
    }

    .user-info {
        display: flex;
        font-size: 16px;
        font-weight: 700;
        text-decoration: none;
        color: #FFFBED;
        align-items: center;
    }

    .user-avatar {
        min-width: 36px;
        height: 36px;
        border: 3px solid #FFFBED;
        border-radius: 50%;
        margin: 0 12px 0 0;
    }

    .post-title {
        height: 36px;
        font-size: 24px;
        font-weight: 700;
        display: flex;
        overflow: hidden;
    }

    .post-title a {
        color: #FFFBED;
        text-decoration: none;
    }

    .meme-image {
        max-height: 600px;
        min-height: 100px;
        color: #FFFBED;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        width: 100%;
        background-color: var(--ogambo-black);
        object-fit: contain;
    }

    .meme-image a,
    .meme-image p {
        text-decoration: none;
        color: #FFFBED;
        padding: 12px;
        font-size: 24px;
        font-weight: 700;
    }

    .meme-footer {
        height: 81px;
        padding: 12px;
        align-items: center;
        background-color: #000;
    }

    .footer-buttons {
        display: flex;
        justify-content: space-between;
    }
    
    .meme-footer hr {
        width: 100%;
        margin: 6px 0;
    }

    .post-description {
        background-color: #FFFBED;
        border-radius: 12px;
        color: #121212;
        padding: 36px 18px 18px 18px;
        margin: -36px 0px 12px 0px;
        z-index: 5;
        position: relative;
        width: -webkit-fill-available;
    }

    .post-description-text {
        margin: 0;
        font-weight: 600;
    }

    .post-user-button {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
    }

    .post-user-button a {
        color: #121212;
        font-size: 24px;
        text-decoration: none;
    }

    .footer-buttons {
        justify-content: end;
    }

    .action-buttons {
        display: flex;
        justify-content: start;
        gap: 9px;
    }

    .action-btn {
        background: none;
        width: 57px;
        height: 57px;
        background-color: #000;
        border: 2px solid #1E1E1E;
        border-radius: 12px;
        color: #FFFBED;
        font-size: 30px;
    }

    .action-btn i {
        -webkit-text-stroke: 1px;
    }

    .bi-share {
        margin-left: -5px
    }

    .action-btn.active[data-vote-type="upvote"] {
        color: #4AFFA2;
        border-color: #4AFFA2;
    }

    .action-btn.active[data-vote-type="downvote"] {
        color: #FF4141;
        border-color: #FF4141;
    }

    .action-btn.downvote {
        display: none;
    }

    .hashtags {
        height: 60px;
    }

    .hashtag-name {
        display: inline-block;
        background-color: var(--ogambo-gray);
        color: var (--ogambo-green);
        padding: 4px 8px;
        border: 2px solid #FFFBED;
        border-radius: 8px;
        margin: 0.25rem;
        font-size: 22px;
    }

    .feed-ad-space {
        background-color: var(--ogambo-blue);
        border-radius: 12px;
        padding: 60px 0;
        align-items: center;
        text-align: center;
        color: #FFFBED;
        margin: 12px 0;
        border: 3px solid #FFFBED;
        font-family: 'Space Mono', monospace;
    }

    .hover-red:hover {
        color: #FF4141;
    }

    .hover-blue:hover {
        color: #11D7FF;
    }

    /* .meme-footer {
        height: 60px;
        padding: 12px;
    }

    .action-buttons {
        height: 36px;
        gap: 8px;
    }

    .action-btn {
        border: 1px solid #FFFBED;
        font-size: 16px;
        width: 36px;
        height: 36px;
    }

    .bi-share {
        margin-left: -3px;
    } */

    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .popup-content {
        background: #121212;
        padding: 12px;
        border-radius: 12px;
        text-align: center;
        width: 500px;
        position: relative;
    }

    .popup-image,
    .popup-video {
        max-width: 100%;
        max-height: 400px;
        margin-bottom: 12px;
        border-radius: 10px;
        background-color: #121212;
    }

    .popup-buttons {
        display: flex;
        justify-content: end;
    }

    .popup-content button,
    .popup-content input {
        margin: 10px;
        padding: 10px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        color: #121212;
        font-weight: 700;
        background-color: #FFFBED;
    }

    .popup-buttons button {
        background: none;
        width: 57px;
        height: 57px;
        background-color: #000;
        border: 2px solid #1E1E1E;
        border-radius: 12px;
        color: #FFFBED;
        font-size: 30px;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .popup-buttons button i {
        -webkit-text-stroke: 1px;
    }

    .popup-content input {
        text-align: center;
        border: 1px solid #ccc;
        margin-top: 4px;
    }

    @media (max-width: 1200px) {
        .content-area {
            margin-left: 0;
            margin-right: 0;
            max-width: 100%;
            padding: 12px;
        }
    }

    @media (max-width: 768px) {
        .feed {
            padding-bottom: 154px;
        }
    }

    @media (max-width: 767px) {
        .content-area {
            margin-left: 0;
            margin-right: 0;
            max-width: 100%;
        }

        .feed {
            padding-bottom: 90px;
        }

        .content-title {
            font-size: 16px;
            padding: 40px;
        }

        .meme-header {
            padding: 12px;
        }

        .meme-footer {
            height: 56px;
            padding: 12px;
        }

        .post-title span {
            font-size: 20px;
        }

        .popup-content {
            width: 300px;
        }

        .action-buttons,
        .popup-buttons {
            height: 32px;
            gap: 8px;
        }

        .action-btn,
        .popup-buttons button {
            border-radius: 8px;
            font-size: 16px;
            width: 32px;
            height: 32px;
        }

        .popup-buttons button i {
            font-size: 20px;
        }

        .bi-share {
            margin-left: -2px;
        }
    }

    @media (max-height: 780px) {
        .meme-image {
            max-height: 450px;
        } 
    }

    @media (max-height: 680px) {
        .meme-image {
            max-height: 360px;
        } 
    }
</style>

<main class="content-area">
    <div class="feed">
        {% for post in posts %}
            <div class="meme-card" data-post-id="{{ post.id }}">
                <div class="meme-header">
                    {% if post.user %}
                        <a href="{% url 'user-profile' post.user.username %}" class="user-info">
                            <img src="{{post.user.profile.avatar.url}}" class="user-avatar" alt="">
                            {{post.user}} | {{post.updated|timesince}}
                        </a>
                    {% endif %}
                    {% if post.image or post.video %}
                        <div class="post-title mt-2">    
                            <a href="{% url 'post' post.id %}">
                                <span>{{post.title}}</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="meme-image">
                    {% if post.image %}
                        <img src="{{post.image.url}}" class="meme-image" alt="">
                    {% elif post.video %}
                        <video src="{{post.video.url}}" class="meme-image" loop autoplay></video>
                    {% else %}
                    <a href="{% url 'post' post.id %}">
                        {{post.title}}
                    </a>
                    {% endif %}
                </div>
                <div class="meme-footer">
                    <div class="footer-buttons">
                        <div class="action-buttons">
                            <button class="action-btn downvote"  data-vote-type="downvote" data-post-id="{{post.id}}">
                                <i class="bi bi-arrow-down"></i>
                            </button>
                            <button class="action-btn upvote" data-vote-type="upvote" data-post-id="{{post.id}}">
                                <i class="bi bi-arrow-up"></i>
                            </button>
                            <button class="action-btn toggle-btn" id="toggle-{{post.id}}" onclick="toggleDescription('{{post.id}}')">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <button class="action-btn" onclick="openSharePopup('{{ post.id }}')">
                                <i class="bi bi-send"></i>
                            <button class="action-btn">
                                <i class="bi bi-bookmark"></i>
                            </button>
                        </div>
                    </div>
                    <!-- <hr>
                    <div class="">
                        <p class="hashtags">
                            {% for tag in post.tags.all %}
                                <span class="hashtag-name">#{{ tag.name }}</span>
                                {% if not forloop.last %}
                                {% endif %}
                            {% endfor %}
                        </p>
                    </div> -->
                </div>
            </div>
            <div id="description-{{post.id}}" class="post-description" style="display: none;">
                <!-- {% if post.user %}
                    <a href="{% url 'user-profile' post.user.username %}" class="user-info">
                        <div class="user-avatar"></div>
                        {{post.user}}
                    </a>
                {% endif %} -->
                <!-- <strong>{{post.title}}  <i class="bi bi-arrow-down"></i> {{ post.downvotes }}<i class="bi bi-arrow-up"></i> {{ post.upvotes }}</strong> -->
                {% if post.description %}
                    <p class="post-description-text">{{post.description}}</p>
                {% endif %}
                <!-- <p class="hashtags">
                    {% for tag in post.tags.all %}
                        <span class="hashtags-name">#{{ tag.name }}</span>
                        {% if not forloop.last %}
                        {% endif %}
                    {% endfor %}
                </p> -->
                {% if request.user == post.user %}
                <div class="post-user-button">
                    <a class="" href="{% url 'delete-post' post.id %}"><i class="bi bi-trash-fill hover-red"></i></a>
                    <a class="" href="{% url 'update-post' post.id %}"><i class="bi bi-pencil-fill hover-blue"></i></a>
                </div>
                {% endif %}
            </div>
        {% endfor %}

        <div class="feed-ad-space">
            Advertisement
        </div>
    </div>
</main>

<div id="sharePopup" class="popup" style="display: none;">
    <div class="popup-content">
        <!-- Media Container -->
        <div id="popupMediaContainer" class="popup-media-container"></div>

        <div class="popup-buttons">     
            <!-- Cancel Button -->
            <button onclick="closeSharePopup()"><i class="bi bi-x-lg"></i></button>
            <input type="text" id="postLink" value="" readonly hidden>
            <button onclick="copyLink()"><i class="bi bi-link-45deg"></i></button>
            <a id="downloadButton" href="" download>
                <button><i class="bi bi-download"></i></button>
            </a>
        </div>
    </div>
</div>


<script>
    function toggleDescription(postId) {
        const descriptionElement = document.getElementById(`description-${postId}`);
        if (descriptionElement) {
            if (descriptionElement.style.display === "none" || !descriptionElement.style.display) {
                descriptionElement.style.display = "block";
            } else {
                descriptionElement.style.display = "none";
            }
        } else {
            console.error(`Description element with ID description-${postId} not found.`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const voteButtons = document.querySelectorAll('.vote-btn, .action-btn');
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        voteButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the click from affecting parent elements

                const postId = button.getAttribute('data-post-id');
                const voteType = button.getAttribute('data-vote-type');

                fetch(`/vote/${postId}/${voteType}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    // Change button colors based on vote type
                    const upvoteButton = document.querySelector(`button[data-post-id="${postId}"][data-vote-type="upvote"]`);
                    const downvoteButton = document.querySelector(`button[data-post-id="${postId}"][data-vote-type="downvote"]`);

                    // Reset button colors first
                    upvoteButton.style.color = "";
                    downvoteButton.style.color = "";

                    if (voteType === "upvote") {
                        upvoteButton.classList.add('active');
                        downvoteButton.classList.remove('active');
                    } else if (voteType === "downvote") {
                        downvoteButton.classList.add('active');
                        upvoteButton.classList.remove('active');
                    }

                })
                .catch(error => console.error('Error:', error));
            });
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const videos = document.querySelectorAll('video');

        // Set up the IntersectionObserver
        const observerOptions = {
            root: null, // Use the viewport as the root
            rootMargin: '0px',
            threshold: 0.5, // Play/pause video when 50% of it is visible
        };

        const videoObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                const video = entry.target;

                if (entry.isIntersecting) {
                    video.play(); // Play the video when it's in the viewport
                } else {
                    video.pause(); // Pause the video when it's out of the viewport
                }
            });
        }, observerOptions);

        // Observe each video
        videos.forEach(video => {
            videoObserver.observe(video);
        });
    });
    
    function openSharePopup(postId) {
        const popup = document.getElementById('sharePopup');
        const popupMediaContainer = document.getElementById('popupMediaContainer');
        const postLinkInput = document.getElementById('postLink');
        const downloadButton = document.getElementById('downloadButton');

        // Find the post card by post ID
        const postCard = document.querySelector(`.meme-card[data-post-id="${postId}"]`);
        const postImage = postCard ? postCard.querySelector('.meme-image img') : null;
        const postVideo = postCard ? postCard.querySelector('.meme-image video') : null;

        // Clear the previous media in the popup
        popupMediaContainer.innerHTML = '';

        // Add media to the popup
        if (postImage) {
            const imgElement = document.createElement('img');
            imgElement.src = postImage.src;
            imgElement.alt = "Post Image";
            imgElement.className = 'popup-image';
            popupMediaContainer.appendChild(imgElement);

            // Set the download URL for the image
            downloadButton.href = `${window.location.origin}/post/${postId}/download/`;
            downloadButton.download = `image_${postId}.png`;
        } else if (postVideo) {
            const videoElement = document.createElement('video');
            videoElement.src = postVideo.src;
            videoElement.controls = true;
            videoElement.className = 'popup-video';
            popupMediaContainer.appendChild(videoElement);

            // Set the download URL for the video
            downloadButton.href = `${window.location.origin}/post/${postId}/download/`;
            downloadButton.download = `video_${postId}.${postVideo.src.split('.').pop()}`; // Ensure extension is correct
        } else {
            popupMediaContainer.innerHTML = '<p>No media available for this post.</p>';
            downloadButton.href = '';
        }

        // Set the link to copy
        const postUrl = `${window.location.origin}/post/${postId}`;
        postLinkInput.value = postUrl;

        // Show the popup
        popup.style.display = 'flex';
    }

    function closeSharePopup() {
        const popup = document.getElementById('sharePopup');
        popup.style.display = 'none';
    }

    function copyLink() {
        const postLinkInput = document.getElementById('postLink');
        postLinkInput.select();
        postLinkInput.setSelectionRange(0, 99999); // For mobile devices

        navigator.clipboard.writeText(postLinkInput.value)
            .then(() => {
                alert("Post link copied to clipboard!");
            })
            .catch(() => {
                alert("Failed to copy the link. Please try again.");
            });
    }
</script>